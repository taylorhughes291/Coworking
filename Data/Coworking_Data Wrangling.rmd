---
title: Data Wrangling for Coworking Space Market Feasibility Project
output:
  html_document: default
  pdf_document: default
---
# What data do we need?
We are attempting to put together a demographic sample of citizens of our market areas, South Coast Santa Barbara and pertinent Ventura County areas, in order to gauge if demographics and information about the area show evidence of a strong likelihood /potential for locals to want to join our coworking space as members. However, glancing at the data dictionary for the PUMS data provided by the US Government, we see that there are 285 variables entered about these folks - which I doubt we will even come close to needing all of this information.

## 2016 Global Coworking Survey - What statistics are we searching for?
As a result of this, instead we will look to another important piece of this puzzle - the [2016 Global Coworking Survey Demographic](https://www.slideshare.net/carstenfoertsch/coworking-in-the-usa-2016). Please note that this is data extrapolated only for the United States, which is more helpful to us compared to global information. 

### Distance to home
Starting on this page at slide 47, we see a list of the top ten reasons why folks choose a coworking space. Most of these things are factors that we have to take control of in terms of our environment, but there is one that translates toward a demographic market feasibility: A close distance to home.

Continuing on to slide 57, we see the breakdown of how folks get to their coworking spaces:

* Driving: 51%
* Cycling: 22%
* Walking: 19%
* Public Transit: 8%

In addition, we see that in an area with the market size we're looking at, 81% of respondents will arrive to their coworking space within 20 minutes of departing their house.

### Age of Member
Moving on to slide 49, we see the age breakdown of participants of the survey which is clearly important:

* Age 18-29: 28%
* Age 30-39: 39%
* Age 40-49: 19%
* Age 50-59: 13%
* Age 60+: 1%

### Job Status
On slide 51 we can see that job status could play a role in who the makeup of members are. According to survey results (as referenced on slide 76), as an owner of a coworking space you want to prioritize the acceptance of freelancers and entrepreneurs as members. The reasoning for this is that many folks join these spaces for networking and collaboration - people want to use the space to find contracts, job opportunities, or to see if there are any folks around who want to collaborate on a project with them (I must admit - sounds pretty exciting!).  We see the following:

* Employee: 51%
* Entrepreneur: 12%
* Freelancer: 32%
* Other: 5%

Moving over to slide 55, we further see the following breakdown of Job type:

* IT (Software Engineer, Web Developer): 27%
* Consulting: 15%
* PR, Marketing, Sales, Advertising: 5%
* Design: 7%
* Project Management: 4%
* Research: 4%
* Writing: 5%
* Business Development (includes entrepreneurs): 3%
* Education: 5%
* Higher Management: 5%
* Art: 3%
* Other: 16%

### Gender
As reported by coworking spaces, the average share of female members sits at 38%; as reported by the individual member respondents, 41% of them were female. Let's sit at a happy medium of 40%.

### Relationship Status
In the US, relationship status of survey respondents were as follows:

* Single: 19%
* In a relationship, unmarried: 22%
* Married: 47%
* Separated, Divorced, Widowed: 7%
* Other or NA: 5%

In addition to marital status, [The 2017 Global Coworking Survey](https://www.slideshare.net/carstenfoertsch/members-of-coworking-spaces-demographic-background-global-coworking-survey-80058366) contains global information regarding number of children of respondents:

* 0 children: 64%
* 1 child: 11%
* 2 children: 18%
* 3 children: 7%

### Health Insurance of members
In the US, the following breakdown of health insurance per respondent was as follows:

* Enhanced Health Insurance: 35%
* Basic Health Insurance: 52%
* No Health Insurance: 9%
* Other: 1%
* NA: 3%

### Last place of work - before starting coworking
In the US, the following breakdown illustrates where respondents worked before deciding to go to a coworking space:

* Home Office: 44%
* Traditional Office: 37%
* Coffee Shop: 11%
* Small Shared Office Community: 2%
* No Fixed Location: 6%

### Highest Level of School Education
As seen in [The 2017 Global Coworking Survey](https://www.slideshare.net/carstenfoertsch/members-of-coworking-spaces-demographic-background-global-coworking-survey-80058366), we also have information on education levels of survey respondents on slide 5:

* Doctoral or higher: 4%
* Master: 41%
* Bachelor: 41%
* High School: 10%
* No Education: 1%
* NA: 3%

### Relative Income
The survey contains information regarding how the respondent gauges their own level of income vs. their cost of living. I really wish this would be represented better, as straight income data, but we'll see what we can do with this later on. As seen on slide 60, respondents rated their income compared to cost of living as:

* Very High: 5%
* Rather High: 34%
* Somewhere in the Middle: 45%
* Rather Low: 9%
* Very Low: 1%
* NA: 6%

## What data do we need?
In summary, we need to be on the lookout for the following in our PUMS Data:

* Does the person Drive, Bike, Walk, or Transit as their commute?
* How long would that person's mode of transportation take to get to our coworking space?
* What is the age of the person?
* What is the person's job type?
* What field does the person work in?
* What is the person's gender?
* What is the person's marital status?
* How many children does the person have?
* What type of health insurance does the person have, if any?
* What is the person's current workspace?
* What is that person's highest level of education?
* What is this person's relative income?

Checking out the [PUMS Data Dictionary](https://www2.census.gov/programs-surveys/acs/tech_docs/pums/data_dict/PUMSDataDict16.pdf) we can see what columns correlate to our desired variables.

* Mode of Transportation: "JWTR"
* Travel Time to Work: We need to create this variable using Google Maps API using "JWAP" and "PUMA"
* Age: "AGEP"
* Job Type: "COW"
* Occupation: "OCCP"
* Gender: "SEX"
* Marital Status: "MAR"
* Number of Children: "NOC"
* Health Insurance Status: "HICOV"
* Current Workspace: "JWTR" contains Home Office information
* Education information: "SCHL"
* Income Information: "HINCP" adjusted by "ADJINC"

# How to get this data

Before you start, make sure you have the following packages installed. Feel free to copy and paste the following into your console:

install.packages("tidycensus")
install.packages("tidyverse")
install.packages("dplyr")
install.packages("data.table")
install.packages("bit64")
install.packages("gmapsdistance")

We can get a sample of data from our market areas by going to the [PUMS Data Website](https://factfinder.census.gov/faces/nav/jsf/pages/searchresults.xhtml?refresh=t) and following these steps:

* In the "topic name" search bar, type "PUMS" and hit search. Wait for your search to load.
* Click "2016 ACS 1-year Public Use Microdata Samples (PUMS) - CSV format". You should be directed to a new page.
* Select "California Population Records". Your browser should begin downloading a CSV file. It should be very large. Save this to the folder "Starting Point Data Files" in the repository for this R Project. It is recommended that you delete this file once you have run the script below due to its very large size.
* Navigate to the [list of PUMA codes](https://www2.census.gov/geo/pdfs/reference/puma/2010_PUMA_Names.pdf) on the US Census website and search for the PUMA codes you're looking for. In my case, I need Santa Barbara South Coast (8303), Ventura City (11104), Oxnard/Port Hueneme (11103), and Moorpark area for good measure (11106).
* Run the R script below in order to get only the market areas you want from this file. This script will also save your filtered result in a file that will take much less time to read upon subsequent analyses, as long as you have begun this activity from the designated R Project instead of just this file alone.

```{r,echo=FALSE,message=FALSE,warning=FALSE}
library(knitr)
opts_chunk$set(tidy.opts=list(width.cutoff=80),tidy=TRUE)
```

```{r}
Census <- read.csv("Starting Point Data Files/ss16pca.csv")
MarketCensus <- Census[Census$PUMA == 08303 | Census$PUMA == 11104 | Census$PUMA == 11103 | Census$PUMA == 11106, ]

MarketCensus <- subset(MarketCensus, select = c(JWTR, JWAP, AGEP, COW, OCCP, SEX, MAR, HICOV, SCHL, HINCP, ADJINC, PUMA))

write.csv(MarketCensus, file = "Starting Point Data Files/PUMS Data SB-Ventura County Market Areas.csv")
```

I now recommend you to delete the "ss16pca.csv" file from the directory if you plan on sharing your results online or in a repository, due to its size. If you need to reference your information on your market area, you can now access via the file "Starting Point Data Files/PUMS Data SB-Ventura County Market Areas.csv".

--------------------------------------------------------

```{r, echo = FALSE, message = FALSE, warning = FALSE}
library(tidycensus)
library(tidyverse)
library(dplyr)
library(data.table)
library(bit64)
library(gmapsdistance)
census_api_key("baa4385d952532460bbc284b6763cf9d3fe75e31")
```
```{r, warning = FALSE, message = FALSE}
# In order to get the FIPS Code for Santa Barbara and Ventura Counties
data(fips_codes)
subset(fips_codes, county == "Santa Barbara County" | county == "Ventura County")
# Looks like SB County is 083 and Ventura County is 111

# Now if we want to get population by Census Tract in Santa Barbara and Ventura Counties
CensusPop <- get_acs(geography = "tract", 
                     variables = "B01003_001", 
                     state = "CA", 
                     county = c("083","111"))
names(CensusPop)[names(CensusPop) == "estimate"] <- "Population"

# In order to get the latitude and longitude of the census tracts

CensusLoc <- fread("https://www2.census.gov/geo/docs/maps-data/data/gazetteer/2017_Gazetteer/2017_gaz_tracts_06.txt")
CensusLoc$GEOID <- as.character(CensusLoc$GEOID)
CensusLoc$GEOID <- paste("0", CensusLoc$GEOID, sep = "")

# Now we have all the CA census tracts geographic location. Let's try and only select the census tracts we need for our two counties. We know that CA code is 06, SB county code is 083, and Ventura county code is 111. GEOID is structured as STATE+COUNTY+TRACT (number of digits SS-CCC-TTTTTT). Please note that fread() above got rid of the leading 0 of the state ID. Also note that all of the GEOIDs we need are included in the Data Frame CensusPop. Let's try and join up the census population data and the census locations, knowing that all the GEOIDs we want are in CensusPop. Merge will only show the matches so it should work well.

CensusPop <- merge(x = CensusPop, y = CensusLoc, by = "GEOID")

# Note that Google Maps API requires LAT-LONG format.
CensusPop$GoogleInput <- paste(CensusPop$INTPTLAT, CensusPop$INTPTLONG, sep = "+")

# Drop unnecessary columns
CensusPop <- subset(CensusPop, select = -c(variable, USPS, ALAND, AWATER))

# We can now get the travel time to Carpinteria per census tract using Google Maps API for car, public transport, and bike. Please note that since there is a limit of 2,500 calls to Google Maps API per day, you may have problems with this in larger market areas. Make sure you have install.packages(gmapsdistance) and you have registered for a Google Maps API Key at https://developers.google.com/maps/documentation/distance-matrix/get-api-key#key. Then make sure you run the command set.api.key("YOUR KEY HERE") 


tomorrow <- as.character(Sys.Date() + 1)
DriveTime <- gmapsdistance(origin = CensusPop$GoogleInput, 
                                     destination = "410+Palm+Ave,+Carpinteria,+CA+93013",
                                     mode = "driving",
                                     arr_date = tomorrow,
                                     arr_time = "17:00:00")

BikeTime <- gmapsdistance(origin = CensusPop$GoogleInput, 
                                    destination = "410+Palm+Ave,+Carpinteria,+CA+93013",
                                    mode = "bicycling",
                                    key = "AIzaSyAT1wxOfPoPZowF2lPliMGA884ArKVQ7XU",
                                    arr_date = tomorrow,
                                    arr_time = "17:00:00")

TransitTime <- gmapsdistance(origin = CensusPop$GoogleInput, 
                                    destination = "410+Palm+Ave,+Carpinteria,+CA+93013",
                                    mode = "transit",
                                    key = "AIzaSyAT1wxOfPoPZowF2lPliMGA884ArKVQ7XU",
                                    arr_date = tomorrow,
                                    arr_time = "17:00:00")

# DriveTime is a list with three data frames (Time, Distance, Status). Let's get Time over to the CensusPop Data Frame as DrivingTime variable.

DriveTime$Time$or <- as.character(DriveTime$Time$or)
names(DriveTime$Time) <- c("GoogleInput", "DrivingTime")
CensusPop <- merge(x = CensusPop, y = DriveTime$Time, by = "GoogleInput")

BikeTime$Time$or <- as.character(BikeTime$Time$or)
names(BikeTime$Time) <- c("GoogleInput", "BikingTime")
CensusPop <- merge(x = CensusPop, y = BikeTime$Time, by = "GoogleInput")

TransitTime$Time$or <- as.character(TransitTime$Time$or)
names(TransitTime$Time) <- c("GoogleInput", "TransitTime")
CensusPop <- merge(x = CensusPop, y = TransitTime$Time, by = "GoogleInput")


# Now we must filter out ONLY the market areas we want to look at. We wish to eliminate Santa Maria area, inland Ventura county, and any farmland areas where agriculture are the biggest industries. Also, these areas are simply too far away and not as easily accessible so it's too difficult to target folks from these areas anyway. We will stick to South Coast SB, Ventura City, Oxnard, Port Hueneme, and Moorpark for good measure.

PUMATractDecoder <- fread("https://www2.census.gov/geo/docs/maps-data/data/rel/2010_Census_Tract_to_2010_PUMA.txt", colClasses = c("character", "character", "character", "character"))
PUMATractDecoder <- PUMATractDecoder[PUMATractDecoder$STATEFP == "06" & 
                                    (PUMATractDecoder$PUMA5CE == "08303" | 
                                     PUMATractDecoder$PUMA5CE == "11104" | 
                                     PUMATractDecoder$PUMA5CE == "11103" | 
                                     PUMATractDecoder$PUMA5CE == "11106"), ]


PUMATractDecoder$GEOID <- paste(PUMATractDecoder$STATEFP, 
                                PUMATractDecoder$COUNTYFP, 
                                PUMATractDecoder$TRACTCE,
                                sep = "")

CensusPop <- merge(x = CensusPop, y = PUMATractDecoder, by = "GEOID")
# Write it to an excel file to analyze or reference later
write.table(CensusPop, file = "SB-Ventura Census Tract Populations.txt", row.names = FALSE)
```
